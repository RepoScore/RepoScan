/*
  # Add Vulnerability Tracking to Repository Scans

  1. Schema Changes
    - Add `vulnerabilities` JSONB column to `repo_scans` table
      - Will store array of vulnerability objects with:
        - severity: critical/high/medium/low
        - type: dependency/code-pattern/configuration
        - description: what was found
        - location: where in the codebase
        - cve_id: CVE identifier (if applicable)
    
    - Add `vulnerability_summary` JSONB column to `repo_scans` table
      - Will store counts by severity and type:
        - total_count
        - critical_count
        - high_count
        - medium_count
        - low_count
        - by_type: {dependency, code_pattern, configuration}

  2. Notes
    - Uses JSONB for flexible vulnerability data structure
    - Allows for detailed tracking and filtering
    - Supports both NVD/Snyk-style dependency vulnerabilities and AST-detected code patterns
*/

-- Add vulnerability tracking columns to repo_scans
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'repo_scans' AND column_name = 'vulnerabilities'
  ) THEN
    ALTER TABLE repo_scans ADD COLUMN vulnerabilities JSONB DEFAULT '[]'::jsonb;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'repo_scans' AND column_name = 'vulnerability_summary'
  ) THEN
    ALTER TABLE repo_scans ADD COLUMN vulnerability_summary JSONB DEFAULT '{
      "total_count": 0,
      "critical_count": 0,
      "high_count": 0,
      "medium_count": 0,
      "low_count": 0,
      "by_type": {
        "dependency": 0,
        "code_pattern": 0,
        "configuration": 0
      }
    }'::jsonb;
  END IF;
END $$;
